% -*- coding: utf-8 -*-
% Расширение окружения: \protect\ic{(enrich \protect\ii{env} 'x 'y)}
\begin{tikzpicture}
  \def\var#1{\footnotesize $\langle\,\text{\ic{#1}}\,\rangle$}
  \tikzstyle{every node}=[font=\small]

  \draw (0.0em, 0.1em) node[anchor = south west] {\ii{записи активаций}};

  \draw [semithick] (0.0em,  0.00em) rectangle (4.0em, -3.75em);
  \draw             (0.0em, -1.25em) -- (4.0em, -1.25em);
  \draw [dashed]    (0.0em, -2.50em) -- (4.0em, -2.50em);

  \filldraw  (2.0em, -0.625em) circle(1.0pt);
  \draw [->] (2.0em, -0.625em) -- (7.25em, -0.625em);

  \draw [semithick] (7.5em,  0.00em) rectangle (11.5em, -5.00em);
  \draw             (7.5em, -1.25em) -- (11.5em, -1.25em);
  \draw [dashed]    (7.5em, -2.50em) -- (11.5em, -2.50em);
  \draw [dashed]    (7.5em, -3.75em) -- (11.5em, -3.75em);

  \filldraw  (9.5em, -0.625em) circle(1.0pt);
  \draw [->] (9.5em, -0.625em) -- (13.50em, -0.625em);

  \draw (13.3em, -0.55em) node[right] {\ii{nil}};

  \draw (2.0em, -1.875em) node {\var{foo}};
  \draw (9.5em, -4.375em) node {\var{bar}};



  \draw (-6.5em, 0.1em) node[above, text width = 4.5em, align = left]
          {\ii{реифицированное окружение}};

  \draw [semithick] (-8.0em, 0.0em) rectangle (-5.0em, -2.5em);
  \draw             (-8.0em, -1.25em) -- (-5.0em, -1.25em);

  \filldraw  (-6.5em, -0.625em) circle(1.0pt);
  \draw [->] (-6.5em, -0.625em) -- (-0.25em, -0.625em);

  \filldraw  (-6.5em, -1.875em) circle(1.0pt);
  \draw [->] (-6.5em, -1.875em) -- (-6.5em, -4.5em);

  \draw (-8.5em, -4.0em) node[rectangle, anchor = north west] {%
\begin{code:lisp}
( (foo (local 0 0))
  (bar (local 1 2))
  ... )
\end{code:lisp}};



  \draw (-4.5em, -9.4em) node[anchor = south west] {\ii{запись активации}};

  \draw [semithick] (-4.5em, -9.5em) rectangle (-0.5em, -13.25em);
  \draw             (-4.5em, -10.75em) -- (-0.5em, -10.75em);
  \draw [dashed]    (-4.5em, -12.00em) -- (-0.5em, -12.00em);

  \filldraw  (-2.5em, -10.125em) circle(1.0pt);
  \draw      (-2.5em, -10.125em) -- (-2.5em, -9.125em);
  \draw      (-2.5em,  -8.250em) -- (-2.5em, -6.900em);
  \draw [->] (-2.5em,  -4.750em) -- (-2.5em, -2.750em);
  \draw      (-2.5em,  -3.500em) -- (-2.5em, -0.625em);

  \draw (-2.5em, -11.375em) node {\var{x}};
  \draw (-2.5em, -12.625em) node {\var{y}};



  \draw (-14.0em, -9.4em) node[above, text width = 4.5em, align = left]
          {\ii{реифицированное окружение}};

  \draw [semithick] (-15.5em, -9.5em) rectangle (-12.5em, -12.0em);
  \draw             (-15.5em, -10.75em) -- (-12.5em, -10.75em);

  \filldraw  (-14.0em, -10.125em) circle(1.0pt);
  \draw [->] (-14.0em, -10.125em) -- (-4.75em, -10.125em);

  \filldraw  (-14.0em, -11.375em) circle(1.0pt);
  \draw [->] (-14.0em, -11.375em) -- (-14.0em, -14.0em);

  \draw (-16.0em, -13.5em) node[rectangle, anchor = north west] {%
\begin{code:lisp}
( (x (checked-local 0 0))
  (y (checked-local 0 1))
  (foo (local 1 0))
  (bar (local 2 2))
  ... )
\end{code:lisp}};

\end{tikzpicture}
